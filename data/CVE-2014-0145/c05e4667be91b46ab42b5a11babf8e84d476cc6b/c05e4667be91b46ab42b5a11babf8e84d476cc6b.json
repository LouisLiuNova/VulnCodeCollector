{
    "owner": "qemu",
    "repo": "qemu",
    "commit_sha": "c05e4667be91b46ab42b5a11babf8e84d476cc6b",
    "commit_massage": "qcow2: Fix L1 allocation size in qcow2_snapshot_load_tmp() (CVE-2014-0145)\n\nFor the L1 table to loaded for an internal snapshot, the code allocated\nonly enough memory to hold the currently active L1 table. If the\nsnapshot's L1 table is actually larger than the current one, this leads\nto a buffer overflow.\n\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>",
    "raw_ref": "https://api.github.com/repos/qemu/qemu/commits/c05e4667be91b46ab42b5a11babf8e84d476cc6b",
    "html_ref": "https://github.com/qemu/qemu/commit/c05e4667be91b46ab42b5a11babf8e84d476cc6b",
    "author": "kevmw",
    "changes_stats": {
        "total": 24,
        "additions": 22,
        "deletions": 2
    },
    "files": [
        {
            "sha": "715168e31ff1d1134e048c2b9848f24955114100",
            "filename": "block/qcow2-snapshot.c",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/qemu/qemu/blob/c05e4667be91b46ab42b5a11babf8e84d476cc6b/block%2Fqcow2-snapshot.c",
            "raw_url": "https://github.com/qemu/qemu/raw/c05e4667be91b46ab42b5a11babf8e84d476cc6b/block%2Fqcow2-snapshot.c",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/block%2Fqcow2-snapshot.c?ref=c05e4667be91b46ab42b5a11babf8e84d476cc6b",
            "patch": "@@ -680,7 +680,7 @@ int qcow2_snapshot_load_tmp(BlockDriverState *bs,\n     sn = &s->snapshots[snapshot_index];\n \n     /* Allocate and read in the snapshot's L1 table */\n-    new_l1_bytes = s->l1_size * sizeof(uint64_t);\n+    new_l1_bytes = sn->l1_size * sizeof(uint64_t);\n     new_l1_table = g_malloc0(align_offset(new_l1_bytes, 512));\n \n     ret = bdrv_pread(bs->file, sn->l1_table_offset, new_l1_table, new_l1_bytes);"
        },
        {
            "sha": "fa46ace67b4a358a19709ea0eb9cd66ce0301d67",
            "filename": "tests/qemu-iotests/029",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/qemu/qemu/blob/c05e4667be91b46ab42b5a11babf8e84d476cc6b/tests%2Fqemu-iotests%2F029",
            "raw_url": "https://github.com/qemu/qemu/raw/c05e4667be91b46ab42b5a11babf8e84d476cc6b/tests%2Fqemu-iotests%2F029",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/tests%2Fqemu-iotests%2F029?ref=c05e4667be91b46ab42b5a11babf8e84d476cc6b",
            "patch": "@@ -30,7 +30,8 @@ status=1\t# failure is the default!\n \n _cleanup()\n {\n-\t_cleanup_test_img\n+    rm -f $TEST_IMG.snap\n+    _cleanup_test_img\n }\n trap \"_cleanup; exit \\$status\" 0 1 2 3 15\n \n@@ -44,6 +45,9 @@ _supported_fmt qcow2\n _supported_proto generic\n _supported_os Linux\n \n+offset_size=24\n+offset_l1_size=36\n+\n echo\n echo Test loading internal snapshots where the L1 table of the snapshot\n echo is smaller than the current L1 table.\n@@ -77,6 +81,18 @@ _make_test_img 64M\n _check_test_img\n \n \n+echo\n+echo \"qcow2_snapshot_load_tmp() should take the L1 size from the snapshot\"\n+echo\n+\n+CLUSTER_SIZE=512\n+_make_test_img 64M\n+{ $QEMU_IMG snapshot -c foo $TEST_IMG; } 2>&1 | _filter_qemu_io | _filter_testdir\n+poke_file \"$TEST_IMG\" \"$offset_size\" \"\\x00\\x00\\x00\\x00\\x00\\x00\\x02\\x00\"\n+poke_file \"$TEST_IMG\" \"$offset_l1_size\" \"\\x00\\x00\\x00\\x01\"\n+{ $QEMU_IMG convert -s foo $TEST_IMG $TEST_IMG.snap; } 2>&1 | _filter_qemu_io | _filter_testdir\n+\n+\n # success, all done\n echo \"*** done\"\n rm -f $seq.full"
        },
        {
            "sha": "ce0e64d24a1825abf2687714a9ddfcfe29550ef8",
            "filename": "tests/qemu-iotests/029.out",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/qemu/qemu/blob/c05e4667be91b46ab42b5a11babf8e84d476cc6b/tests%2Fqemu-iotests%2F029.out",
            "raw_url": "https://github.com/qemu/qemu/raw/c05e4667be91b46ab42b5a11babf8e84d476cc6b/tests%2Fqemu-iotests%2F029.out",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/tests%2Fqemu-iotests%2F029.out?ref=c05e4667be91b46ab42b5a11babf8e84d476cc6b",
            "patch": "@@ -20,4 +20,8 @@ wrote 4096/4096 bytes at offset 1099511627776\n read 4096/4096 bytes at offset 1099511627776\n 4 KiB, X ops; XX:XX:XX.X (XXX YYY/sec and XXX ops/sec)\n No errors were found on the image.\n+\n+qcow2_snapshot_load_tmp() should take the L1 size from the snapshot\n+\n+Formatting 'TEST_DIR/t.IMGFMT', fmt=IMGFMT size=67108864 \n *** done"
        }
    ],
    "parent_commit_sha": "11b128f4062dd7f89b14abc8877ff20d41b28be9"
}