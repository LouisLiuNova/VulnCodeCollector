{
    "owner": "qemu",
    "repo": "qemu",
    "commit_sha": "6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f",
    "commit_massage": "qcow2: Check maximum L1 size in qcow2_snapshot_load_tmp() (CVE-2014-0143)\n\nThis avoids an unbounded allocation.\n\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>",
    "raw_ref": "https://api.github.com/repos/qemu/qemu/commits/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f",
    "html_ref": "https://github.com/qemu/qemu/commit/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f",
    "author": "kevmw",
    "changes_stats": {
        "total": 33,
        "additions": 29,
        "deletions": 4
    },
    "files": [
        {
            "sha": "5db4f30c8205ac6d23c472df00b9cec8988e3aef",
            "filename": "block/qcow2-snapshot.c",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/qemu/qemu/blob/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/block%2Fqcow2-snapshot.c",
            "raw_url": "https://github.com/qemu/qemu/raw/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/block%2Fqcow2-snapshot.c",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/block%2Fqcow2-snapshot.c?ref=6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f",
            "patch": "@@ -680,6 +680,10 @@ int qcow2_snapshot_load_tmp(BlockDriverState *bs,\n     sn = &s->snapshots[snapshot_index];\n \n     /* Allocate and read in the snapshot's L1 table */\n+    if (sn->l1_size > QCOW_MAX_L1_SIZE) {\n+        error_setg(errp, \"Snapshot L1 table too large\");\n+        return -EFBIG;\n+    }\n     new_l1_bytes = sn->l1_size * sizeof(uint64_t);\n     new_l1_table = g_malloc0(align_offset(new_l1_bytes, 512));\n "
        },
        {
            "sha": "bb6000f7dce3bed43e48e013de8ac4706813f2f6",
            "filename": "block/qcow2.c",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/qemu/qemu/blob/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/block%2Fqcow2.c",
            "raw_url": "https://github.com/qemu/qemu/raw/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/block%2Fqcow2.c",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/block%2Fqcow2.c?ref=6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f",
            "patch": "@@ -638,9 +638,7 @@ static int qcow2_open(BlockDriverState *bs, QDict *options, int flags,\n     }\n \n     /* read the level 1 table */\n-    if (header.l1_size > 0x2000000) {\n-        /* 32 MB L1 table is enough for 2 PB images at 64k cluster size\n-         * (128 GB for 512 byte clusters, 2 EB for 2 MB clusters) */\n+    if (header.l1_size > QCOW_MAX_L1_SIZE) {\n         error_setg(errp, \"Active L1 table too large\");\n         ret = -EFBIG;\n         goto fail;"
        },
        {
            "sha": "f28e7d9165cefa5c2a5843d840e17777aa88916d",
            "filename": "block/qcow2.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/qemu/qemu/blob/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/block%2Fqcow2.h",
            "raw_url": "https://github.com/qemu/qemu/raw/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/block%2Fqcow2.h",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/block%2Fqcow2.h?ref=6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f",
            "patch": "@@ -44,6 +44,10 @@\n  * (128 GB for 512 byte clusters, 2 EB for 2 MB clusters) */\n #define QCOW_MAX_REFTABLE_SIZE 0x800000\n \n+/* 32 MB L1 table is enough for 2 PB images at 64k cluster size\n+ * (128 GB for 512 byte clusters, 2 EB for 2 MB clusters) */\n+#define QCOW_MAX_L1_SIZE 0x2000000\n+\n /* indicate that the refcount of the referenced cluster is exactly one. */\n #define QCOW_OFLAG_COPIED     (1ULL << 63)\n /* indicate that the cluster is compressed (they never have the copied flag) */"
        },
        {
            "sha": "6b3a3e77a5f576d0725f0058eb0980520a5c150c",
            "filename": "tests/qemu-iotests/080",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/qemu/qemu/blob/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/tests%2Fqemu-iotests%2F080",
            "raw_url": "https://github.com/qemu/qemu/raw/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/tests%2Fqemu-iotests%2F080",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/tests%2Fqemu-iotests%2F080?ref=6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f",
            "patch": "@@ -30,7 +30,8 @@ status=1\t# failure is the default!\n \n _cleanup()\n {\n-\t_cleanup_test_img\n+    rm -f $TEST_IMG.snap\n+    _cleanup_test_img\n }\n trap \"_cleanup; exit \\$status\" 0 1 2 3 15\n \n@@ -58,6 +59,10 @@ offset_ext_size=$((header_size + 4))\n \n offset_l2_table_0=$((0x40000))\n \n+offset_snap1=$((0x70000))\n+offset_snap1_l1_offset=$((offset_snap1 + 0))\n+offset_snap1_l1_size=$((offset_snap1 + 8))\n+\n echo\n echo \"== Huge header size ==\"\n _make_test_img 64M\n@@ -161,6 +166,14 @@ poke_file \"$TEST_IMG\" \"$offset_l2_table_0\" \"\\xbf\\xff\\xff\\xff\\xff\\xff\\x00\\x00\"\n poke_file \"$TEST_IMG\" \"$offset_l2_table_0\" \"\\x80\\x00\\x00\\xff\\xff\\xff\\x00\\x00\"\n { $QEMU_IMG snapshot -c test $TEST_IMG; } 2>&1 | _filter_qemu_io | _filter_testdir\n \n+echo\n+echo \"== Invalid snapshot L1 table ==\"\n+_make_test_img 64M\n+{ $QEMU_IO -c \"write 0 512\" $TEST_IMG; } 2>&1 | _filter_qemu_io | _filter_testdir\n+{ $QEMU_IMG snapshot -c test $TEST_IMG; } 2>&1 | _filter_testdir\n+poke_file \"$TEST_IMG\" \"$offset_snap1_l1_size\" \"\\x10\\x00\\x00\\x00\"\n+{ $QEMU_IMG convert -s test $TEST_IMG $TEST_IMG.snap; } 2>&1 | _filter_testdir\n+\n # success, all done\n echo \"*** done\"\n rm -f $seq.full"
        },
        {
            "sha": "f7a943c7a4275f163e6f011da5ad2a4120fe49ea",
            "filename": "tests/qemu-iotests/080.out",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/qemu/qemu/blob/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/tests%2Fqemu-iotests%2F080.out",
            "raw_url": "https://github.com/qemu/qemu/raw/6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f/tests%2Fqemu-iotests%2F080.out",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/tests%2Fqemu-iotests%2F080.out?ref=6a83f8b5bec6f59e56cc49bd49e4c3f8f805d56f",
            "patch": "@@ -74,4 +74,10 @@ wrote 512/512 bytes at offset 0\n 512 bytes, X ops; XX:XX:XX.X (XXX YYY/sec and XXX ops/sec)\n qemu-img: Could not create snapshot 'test': -27 (File too large)\n qemu-img: Could not create snapshot 'test': -11 (Resource temporarily unavailable)\n+\n+== Invalid snapshot L1 table ==\n+Formatting 'TEST_DIR/t.IMGFMT', fmt=IMGFMT size=67108864 \n+wrote 512/512 bytes at offset 0\n+512 bytes, X ops; XX:XX:XX.X (XXX YYY/sec and XXX ops/sec)\n+qemu-img: Failed to load snapshot: Snapshot L1 table too large\n *** done"
        }
    ],
    "parent_commit_sha": "c05e4667be91b46ab42b5a11babf8e84d476cc6b"
}