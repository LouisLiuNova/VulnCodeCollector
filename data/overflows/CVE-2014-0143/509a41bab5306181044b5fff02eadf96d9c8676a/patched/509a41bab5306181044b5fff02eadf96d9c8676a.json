{
    "owner": "qemu",
    "repo": "qemu",
    "commit_sha": "509a41bab5306181044b5fff02eadf96d9c8676a",
    "commit_massage": "block/cloop: prevent offsets_size integer overflow (CVE-2014-0143)\n\nThe following integer overflow in offsets_size can lead to out-of-bounds\nmemory stores when n_blocks has a huge value:\n\n    uint32_t n_blocks, offsets_size;\n    [...]\n    ret = bdrv_pread(bs->file, 128 + 4, &s->n_blocks, 4);\n    [...]\n    s->n_blocks = be32_to_cpu(s->n_blocks);\n\n    /* read offsets */\n    offsets_size = s->n_blocks * sizeof(uint64_t);\n    s->offsets = g_malloc(offsets_size);\n\n    [...]\n\n    for(i=0;i<s->n_blocks;i++) {\n        s->offsets[i] = be64_to_cpu(s->offsets[i]);\n\noffsets_size can be smaller than n_blocks due to integer overflow.\nTherefore s->offsets[] is too small when the for loop byteswaps offsets.\n\nThis patch refuses to open files if offsets_size would overflow.\n\nNote that changing the type of offsets_size is not a fix since 32-bit\nhosts still only have 32-bit size_t.\n\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>",
    "raw_ref": "https://api.github.com/repos/qemu/qemu/commits/509a41bab5306181044b5fff02eadf96d9c8676a",
    "html_ref": "https://github.com/qemu/qemu/commit/509a41bab5306181044b5fff02eadf96d9c8676a",
    "author": "stefanhaRH",
    "changes_stats": {
        "total": 18,
        "additions": 18,
        "deletions": 0
    },
    "files": [
        {
            "sha": "563e916266ffff216a0d6560b6f6d9f2fc754ffe",
            "filename": "block/cloop.c",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/qemu/qemu/blob/509a41bab5306181044b5fff02eadf96d9c8676a/block%2Fcloop.c",
            "raw_url": "https://github.com/qemu/qemu/raw/509a41bab5306181044b5fff02eadf96d9c8676a/block%2Fcloop.c",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/block%2Fcloop.c?ref=509a41bab5306181044b5fff02eadf96d9c8676a",
            "patch": "@@ -99,6 +99,13 @@ static int cloop_open(BlockDriverState *bs, QDict *options, int flags,\n     s->n_blocks = be32_to_cpu(s->n_blocks);\n \n     /* read offsets */\n+    if (s->n_blocks > UINT32_MAX / sizeof(uint64_t)) {\n+        /* Prevent integer overflow */\n+        error_setg(errp, \"n_blocks %u must be %zu or less\",\n+                   s->n_blocks,\n+                   UINT32_MAX / sizeof(uint64_t));\n+        return -EINVAL;\n+    }\n     offsets_size = s->n_blocks * sizeof(uint64_t);\n     s->offsets = g_malloc(offsets_size);\n "
        },
        {
            "sha": "9ce6b1fb8c98be4ae1c7a83143996cbfd106494e",
            "filename": "tests/qemu-iotests/075",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/qemu/qemu/blob/509a41bab5306181044b5fff02eadf96d9c8676a/tests%2Fqemu-iotests%2F075",
            "raw_url": "https://github.com/qemu/qemu/raw/509a41bab5306181044b5fff02eadf96d9c8676a/tests%2Fqemu-iotests%2F075",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/tests%2Fqemu-iotests%2F075?ref=509a41bab5306181044b5fff02eadf96d9c8676a",
            "patch": "@@ -43,6 +43,7 @@ _supported_proto generic\n _supported_os Linux\n \n block_size_offset=128\n+n_blocks_offset=132\n \n echo\n echo \"== check that the first sector can be read ==\"\n@@ -67,6 +68,12 @@ _use_sample_img simple-pattern.cloop.bz2\n poke_file \"$TEST_IMG\" \"$block_size_offset\" \"\\xff\\xff\\xfe\\x00\"\n $QEMU_IO -c \"read 0 512\" $TEST_IMG 2>&1 | _filter_qemu_io | _filter_testdir\n \n+echo\n+echo \"== offsets_size overflow ===\"\n+_use_sample_img simple-pattern.cloop.bz2\n+poke_file \"$TEST_IMG\" \"$n_blocks_offset\" \"\\xff\\xff\\xff\\xff\"\n+$QEMU_IO -c \"read 0 512\" $TEST_IMG 2>&1 | _filter_qemu_io | _filter_testdir\n+\n # success, all done\n echo \"*** done\"\n rm -f $seq.full"
        },
        {
            "sha": "a771789548474a5700a960ab4299d12e04694cc3",
            "filename": "tests/qemu-iotests/075.out",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/qemu/qemu/blob/509a41bab5306181044b5fff02eadf96d9c8676a/tests%2Fqemu-iotests%2F075.out",
            "raw_url": "https://github.com/qemu/qemu/raw/509a41bab5306181044b5fff02eadf96d9c8676a/tests%2Fqemu-iotests%2F075.out",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/tests%2Fqemu-iotests%2F075.out?ref=509a41bab5306181044b5fff02eadf96d9c8676a",
            "patch": "@@ -15,4 +15,8 @@ no file open, try 'help open'\n == huge block_size ===\n qemu-io: can't open device TEST_DIR/simple-pattern.cloop: block_size 4294966784 must be 64 MB or less\n no file open, try 'help open'\n+\n+== offsets_size overflow ===\n+qemu-io: can't open device TEST_DIR/simple-pattern.cloop: n_blocks 4294967295 must be 536870911 or less\n+no file open, try 'help open'\n *** done"
        }
    ],
    "parent_commit_sha": "d65f97a82c4ed48374a764c769d4ba1ea9724e97"
}