{
    "owner": "qemu",
    "repo": "qemu",
    "commit_sha": "c165f7758009a4f793c1fc19ebb69cf55313450b",
    "commit_massage": "dmg: sanitize chunk length and sectorcount (CVE-2014-0145)\n\nChunk length and sectorcount are used for decompression buffers as well\nas the bdrv_pread() count argument.  Ensure that they have reasonable\nvalues so neither memory allocation nor conversion from uint64_t to int\nwill cause problems.\n\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>",
    "raw_ref": "https://api.github.com/repos/qemu/qemu/commits/c165f7758009a4f793c1fc19ebb69cf55313450b",
    "html_ref": "https://github.com/qemu/qemu/commit/c165f7758009a4f793c1fc19ebb69cf55313450b",
    "author": "stefanhaRH",
    "changes_stats": {
        "total": 24,
        "additions": 24,
        "deletions": 0
    },
    "files": [
        {
            "sha": "ad253fe1ed36f2ae4532de4a914cc8a3cb61cb5b",
            "filename": "block/dmg.c",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/qemu/qemu/blob/c165f7758009a4f793c1fc19ebb69cf55313450b/block%2Fdmg.c",
            "raw_url": "https://github.com/qemu/qemu/raw/c165f7758009a4f793c1fc19ebb69cf55313450b/block%2Fdmg.c",
            "contents_url": "https://api.github.com/repos/qemu/qemu/contents/block%2Fdmg.c?ref=c165f7758009a4f793c1fc19ebb69cf55313450b",
            "patch": "@@ -27,6 +27,14 @@\n #include \"qemu/module.h\"\n #include <zlib.h>\n \n+enum {\n+    /* Limit chunk sizes to prevent unreasonable amounts of memory being used\n+     * or truncating when converting to 32-bit types\n+     */\n+    DMG_LENGTHS_MAX = 64 * 1024 * 1024, /* 64 MB */\n+    DMG_SECTORCOUNTS_MAX = DMG_LENGTHS_MAX / 512,\n+};\n+\n typedef struct BDRVDMGState {\n     CoMutex lock;\n     /* each chunk contains a certain number of sectors,\n@@ -208,6 +216,14 @@ static int dmg_open(BlockDriverState *bs, QDict *options, int flags,\n                 }\n                 offset += 8;\n \n+                if (s->sectorcounts[i] > DMG_SECTORCOUNTS_MAX) {\n+                    error_report(\"sector count %\" PRIu64 \" for chunk %u is \"\n+                                 \"larger than max (%u)\",\n+                                 s->sectorcounts[i], i, DMG_SECTORCOUNTS_MAX);\n+                    ret = -EINVAL;\n+                    goto fail;\n+                }\n+\n                 ret = read_uint64(bs, offset, &s->offsets[i]);\n                 if (ret < 0) {\n                     goto fail;\n@@ -221,6 +237,14 @@ static int dmg_open(BlockDriverState *bs, QDict *options, int flags,\n                 }\n                 offset += 8;\n \n+                if (s->lengths[i] > DMG_LENGTHS_MAX) {\n+                    error_report(\"length %\" PRIu64 \" for chunk %u is larger \"\n+                                 \"than max (%u)\",\n+                                 s->lengths[i], i, DMG_LENGTHS_MAX);\n+                    ret = -EINVAL;\n+                    goto fail;\n+                }\n+\n                 if (s->lengths[i] > max_compressed_size) {\n                     max_compressed_size = s->lengths[i];\n                 }"
        }
    ],
    "parent_commit_sha": "eb71803b041f55779ea10d860c0f66df285c68de"
}