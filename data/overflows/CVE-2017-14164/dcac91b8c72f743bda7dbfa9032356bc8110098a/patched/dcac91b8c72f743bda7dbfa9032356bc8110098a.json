{
    "owner": "uclouvain",
    "repo": "openjpeg",
    "commit_sha": "dcac91b8c72f743bda7dbfa9032356bc8110098a",
    "commit_massage": "opj_j2k_write_sot(): fix potential write heap buffer overflow (#991)",
    "raw_ref": "https://api.github.com/repos/uclouvain/openjpeg/commits/dcac91b8c72f743bda7dbfa9032356bc8110098a",
    "html_ref": "https://github.com/uclouvain/openjpeg/commit/dcac91b8c72f743bda7dbfa9032356bc8110098a",
    "author": "rouault",
    "changes_stats": {
        "total": 25,
        "additions": 20,
        "deletions": 5
    },
    "files": [
        {
            "sha": "16915452ea6180603a6b2711be07cc9a3c238127",
            "filename": "src/lib/openjp2/j2k.c",
            "status": "modified",
            "additions": 20,
            "deletions": 5,
            "changes": 25,
            "blob_url": "https://github.com/uclouvain/openjpeg/blob/dcac91b8c72f743bda7dbfa9032356bc8110098a/src%2Flib%2Fopenjp2%2Fj2k.c",
            "raw_url": "https://github.com/uclouvain/openjpeg/raw/dcac91b8c72f743bda7dbfa9032356bc8110098a/src%2Flib%2Fopenjp2%2Fj2k.c",
            "contents_url": "https://api.github.com/repos/uclouvain/openjpeg/contents/src%2Flib%2Fopenjp2%2Fj2k.c?ref=dcac91b8c72f743bda7dbfa9032356bc8110098a",
            "patch": "@@ -832,13 +832,15 @@ static OPJ_BOOL opj_j2k_write_tlm(opj_j2k_t *p_j2k,\n  * Writes the SOT marker (Start of tile-part)\n  *\n  * @param       p_j2k            J2K codec.\n- * @param       p_data           FIXME DOC\n- * @param       p_data_written   FIXME DOC\n+ * @param       p_data           Output buffer\n+ * @param       p_total_data_size Output buffer size\n+ * @param       p_data_written   Number of bytes written into stream\n  * @param       p_stream         the stream to write data to.\n  * @param       p_manager        the user event manager.\n */\n static OPJ_BOOL opj_j2k_write_sot(opj_j2k_t *p_j2k,\n                                   OPJ_BYTE * p_data,\n+                                  OPJ_UINT32 p_total_data_size,\n                                   OPJ_UINT32 * p_data_written,\n                                   const opj_stream_private_t *p_stream,\n                                   opj_event_mgr_t * p_manager);\n@@ -4201,6 +4203,7 @@ static OPJ_BOOL opj_j2k_write_tlm(opj_j2k_t *p_j2k,\n \n static OPJ_BOOL opj_j2k_write_sot(opj_j2k_t *p_j2k,\n                                   OPJ_BYTE * p_data,\n+                                  OPJ_UINT32 p_total_data_size,\n                                   OPJ_UINT32 * p_data_written,\n                                   const opj_stream_private_t *p_stream,\n                                   opj_event_mgr_t * p_manager\n@@ -4214,6 +4217,12 @@ static OPJ_BOOL opj_j2k_write_sot(opj_j2k_t *p_j2k,\n     OPJ_UNUSED(p_stream);\n     OPJ_UNUSED(p_manager);\n \n+    if (p_total_data_size < 12) {\n+        opj_event_msg(p_manager, EVT_ERROR,\n+                      \"Not enough bytes in output buffer to write SOT marker\\n\");\n+        return OPJ_FALSE;\n+    }\n+\n     opj_write_bytes(p_data, J2K_MS_SOT,\n                     2);                                 /* SOT */\n     p_data += 2;\n@@ -11480,7 +11489,8 @@ static OPJ_BOOL opj_j2k_write_first_tile_part(opj_j2k_t *p_j2k,\n \n     l_current_nb_bytes_written = 0;\n     l_begin_data = p_data;\n-    if (! opj_j2k_write_sot(p_j2k, p_data, &l_current_nb_bytes_written, p_stream,\n+    if (! opj_j2k_write_sot(p_j2k, p_data, p_total_data_size,\n+                            &l_current_nb_bytes_written, p_stream,\n                             p_manager)) {\n         return OPJ_FALSE;\n     }\n@@ -11572,7 +11582,10 @@ static OPJ_BOOL opj_j2k_write_all_tile_parts(opj_j2k_t *p_j2k,\n         l_part_tile_size = 0;\n         l_begin_data = p_data;\n \n-        if (! opj_j2k_write_sot(p_j2k, p_data, &l_current_nb_bytes_written, p_stream,\n+        if (! opj_j2k_write_sot(p_j2k, p_data,\n+                                p_total_data_size,\n+                                &l_current_nb_bytes_written,\n+                                p_stream,\n                                 p_manager)) {\n             return OPJ_FALSE;\n         }\n@@ -11615,7 +11628,9 @@ static OPJ_BOOL opj_j2k_write_all_tile_parts(opj_j2k_t *p_j2k,\n             l_part_tile_size = 0;\n             l_begin_data = p_data;\n \n-            if (! opj_j2k_write_sot(p_j2k, p_data, &l_current_nb_bytes_written, p_stream,\n+            if (! opj_j2k_write_sot(p_j2k, p_data,\n+                                    p_total_data_size,\n+                                    &l_current_nb_bytes_written, p_stream,\n                                     p_manager)) {\n                 return OPJ_FALSE;\n             }"
        }
    ],
    "parent_commit_sha": "af760007711bf93041d3eba3a41b9a48d365f303"
}